#!/bin/bash

# __author__ = Firas Said Midani
# __email__ = midani@bcm.edu

# Midani et al. (2021) Supp. Figure 5 and 7 uses data generated by this script 

# Objective
#
# The main illustrations for AMiGA are based on growth data of Clostridioides difficile.
# Here, we aimed to illustrate that AMiGA is not limited to growth curves of C. difficile.
# So, we take advantage of several publicly available growth curve data to showcase the 
# utility of AMiGA. In particular, we use the following data sets:
#
# Cuevas DA and Edwards RA.
# PMAnalyzer: a new web interface for bacterial growth curve analysis.  
# Bioinformatics (2017)
#
# Dunphy LJ, Yan P, and Papin JA.
# Integrated experimental and computational analyses reveal differential metabolic
# functionality in antibiotic-resistant Pseudomonas aeruginosa.
# Cell Systems (2019)
#
# Vervier K, Browne, HP, and Lawley TD.
# CarboLogR: a Shiny/R application for statistical analysis of bacterial utilisation of carbon sources. 
# bioRxiv (2019)
#
# In this script, we download the data sets corresponding to these articles, format them
# so that AMiGA can parse them, and then process the growth curves with AMiGA. 
# 

#########################################
# Point to Python environment and AMiGA #
#########################################

# load amiga source environment
source $1

# create variable for the absolute file path to amiga.py
amiga=$2

# set up environment
mkdir -p ./non_cdiff/{cuevas,dunphy,vervier}

#####################################
# Cuevas 2017: Citrobacter sedlakii #
#####################################

# Download PMAnalyzer from Github
if [[ ! -e $amiga/examples/manuscript/non_cdiff/cuevas/PMAnalyzer ]]; then 
    git clone https://github.com/dacuevas/PMAnalyzer.git $amiga/examples/manuscript/non_cdiff/cuevas/PMAnalyzer
fi

# There are sample data for 3 C. sedlakii isolates. However, only R.S.3_ID952 and R.S.3_ID953 correlate
# well with each other. See ./PMAnalyzer/sample_results/log_R.S.3.png. So, I will only analyze those two isolates.

# These PM plates include both carbon and nitrogen sources. For the analysis, we will exclude the nitrogen
# sources, which would allow for fairer comparison to the other projects (dunphy and vervier)

# first, read sample data and prepare for AMiGA
python $amiga/examples/manuscript/scripts_analysis/py/format_cuevas_files.py

# set up parameters for AMiGA processing
interval=1800
working="$amiga/examples/manuscript/non_cdiff/cuevas/working"
timestepsize=1
skipfirstn=0

# pool then fit curves
python $amiga/amiga.py fit \
    -i $working \
    -o cuevas_pooled --merge-summary \
    -s "Plate_ID:R.S.3_ID952,R.S.3_ID953;Source_Type:Carbon" \
    --pool-by "Substrate" --sample-posterior \
    -t $interval -tss $timestepsize -sfn $skipfirstn --keep-missing-time-points \
    --save-gp-data --save-cleaned-data --verbose

# normalize parameters
python $amiga/amiga.py normalize \
    -i $working/summary/cuevas_pooled_summary.txt \
    --normalize-method "division" --normalize-by "Substrate:Negative Control"


##############################################
# Dunphy 2019: Psuedomonas aeruginosa BIOLOG #
##############################################

# Download code/data from Github
if [[ ! -e $amiga/examples/manuscript/non_cdiff/dunphy/supplement ]]; then 
    git clone https://github.com/lauradunphy/dunphy_yen_papin_supplement.git $amiga/examples/manuscript/non_cdiff/dunphy/supplement
fi

# first, read sample data and prepare for AMiGA
python $amiga/examples/manuscript/scripts_analysis/py/format_dunphy_files.py

# set up parameters for AMiGA processing
interval=600
working="$amiga/examples/manuscript/non_cdiff/dunphy/working"
timestepsize=4
skipfirstn=0

# pool then fit curves
python $amiga/amiga.py fit \
    -i $working \
    -o dunphy_pooled --merge-summary \
    --subset 'Isolate:Day0Anc;PM:1' \
    --pool-by "Isolate,PM,Substrate" --sample-posterior \
    -t $interval -tss $timestepsize -sfn $skipfirstn --keep-missing-time-points \
    --save-gp-data --save-cleaned-data --verbose

# normalize parameters
python $amiga/amiga.py normalize \
    -i $working/summary/dunphy_pooled_summary.txt \
    --normalize-method "division" --group-by "PM,Isolate" --normalize-by "Substrate:Negative Control"


############################################################
# Dunphy 2019: Psuedomonas aeruginosa N-Acetyl-Glucosamine #
############################################################

# first, read sample data and prepare for AMiGA
python $amiga/examples/manuscript/scripts_analysis/py/format_dunphy_glcnac_files.py

interval=639
working="$amiga/examples/manuscript/non_cdiff/dunphy/working"
timestepsize=4
skipfirstn=0

# pool then fit curves
python $amiga/amiga.py fit \
    -i $working/data/dunphy_glcnac_mutants.txt \
    -o dunphy_glcnac_mutants_pooled --merge-summary \
    --pool-by "Strain" --sample-posterior \
    -t $interval -tss $timestepsize -sfn $skipfirstn --keep-missing-time-points \
    --save-gp-data --save-cleaned-data --verbose

# hypothesis testing: compare all strains against the ancestor

# create an array of all the unique strain names
strains=( $(awk '{print $3}' $working/mapping/dunphy_glcnac_mutants.txt | sort | uniq) )
declare -p strains

# compare all strains against ancestor, except for itself
for strain in "${strains[@]}";
do

	if [ $strain = 'Ancestor' ] || [ $strain = 'Strain' ]; then 
		continue
	fi

	python $amiga/amiga.py test \
		-i $working/data/dunphy_glcnac_mutants.txt \
		-o Ancestor_vs_$strain \
		-s 'Strain:Ancestor,'$strain \
		-t $interval -tss $timestepsize -sfn $skipfirstn\
		-y 'H0:Time;H1:Time+Strain' \
		--sample-posterior --confidence 95 -np 0\
		--verbose

done

# hypothesis testing comparing PA14_44360 and PA14_41710

python $amiga/amiga.py test \
	-i $working/data/dunphy_glcnac_mutants.txt \
	-o PA14_44360_vs_PA14_41710 \
	-s 'Strain:PA14_44360,PA14_41710' \
	-t $interval -tss $timestepsize -sfn $skipfirstn\
	-y 'H0:Time;H1:Time+Strain' \
	--sample-posterior --confidence 95 -np 99\
	--verbose


#########################################
# Vervier 2017: Yersinia enterocolitica #
#########################################

# Download CarboLogR from Github
if [[ ! -e $amiga/examples/manuscript/non_cdiff/vervier/CarboLogR ]]; then 
    git clone https://github.com/kevinVervier/CarboLogR.git $amiga/examples/manuscript/non_cdiff/vervier/CarboLogR
fi

# first, read sample data and prepare for AMiGA
python $amiga/examples/manuscript/scripts_analysis/py/format_vervier_files.py

# set up parameters for AMiGA processing
interval=900
working="$amiga/examples/manuscript/non_cdiff/vervier/working"
skipfirstn=0
timestepsize=3

# fit individual curves
python $amiga/amiga.py fit \
    -i $working \
    -o vervier_split --merge-summary \
    --subset 'Isolate:8081c;PM:1' \
    -t $interval \
    --save-gp-data --save-cleaned-data --verbose

## Force a high limit-of-detection because this is a colorimeteric Biolog assay where first measurements
## seem to have an average near 19 (across three replicate Biolog PM1 plates for 8081c) but can be 
## as low as 0 which heavily distorts comparisons between or pooling of curves. 

SRC="config\['handling_nonpositives'\] = 'Delta'"
DST="config\['handling_nonpositives'\] = 'LOD'"
sed -i '.bak' -e "s/$SRC/$DST/g" $amiga/libs/config.py

SRC="config\['limit_of_detection'\] = 0.010"
DST="config\['limit_of_detection'\] = 20"
sed -i '.bak' -e "s/$SRC/$DST/g" $amiga/libs/config.py

SRC="config\['force_limit_of_detection'\] = False"
DST="config\['force_limit_of_detection'\] = True"
sed -i '.bak' -e "s/$SRC/$DST/g" $amiga/libs/config.py

# pool then fit curves
python $amiga/amiga.py fit \
    -i $working \
    -o vervier_pooled --merge-summary \
    --subset 'Isolate:8081c;PM:1' \
    --pool-by "Isolate,PM,Substrate" --sample-posterior \
    -t $interval -tss $timestepsize -sfn $skipfirstn --keep-mi ssing-time-points \
    --save-gp-data --save-cleaned-data --verbose

# normalize parameters
python $amiga/amiga.py normalize \
    -i $working/summary/vervier_split_summary.txt \
    --normalize-method "division" --group-by "Plate_ID" --normalize-by "Substrate:Negative Control"

python $amiga/amiga.py normalize \
    -i $working/summary/vervier_pooled_summary.txt \
    --normalize-method "division" --group-by "PM,Isolate" --normalize-by "Substrate:Negative Control"


## Revert the default values in the config.py
SRC="config\['handling_nonpositives'\] = 'Delta'"
DST="config\['handling_nonpositives'\] = 'LOD'"
sed -i '.bak' -e "s/$DST/$SRC/g" $amiga/libs/config.py

SRC="config\['limit_of_detection'\] = 0.010"
DST="config\['limit_of_detection'\] = 20"
sed -i '.bak' -e "s/$DST/$SRC/g" $amiga/libs/config.py

SRC="config\['force_limit_of_detection'\] = False"
DST="config\['force_limit_of_detection'\] = True"
sed -i '.bak' -e "s/$DST/$SRC/g" $amiga/libs/config.py

## Remove back-up file for config.py
rm $amiga/libs/config.py.bak