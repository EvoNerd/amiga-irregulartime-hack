---
layout: page
title: "Fit Curves"
category: doc
date: 2020-03-25 22:44:30
order: 5
use_math: true
---
<!-- AMiGA is covered under the GPL-3 license -->
**Table of Contents**

* TOC
{:toc}
<br />

#### AMiGA can fit a growth curve using GP regression

`AMiGA` fits growth curves as a Gaussian Process model and uses the model-predicted OD to estimate growth parameters. To fit the curves in your data set, simply run the following command.

```bash
python amiga.py fit -i /home/outbreaks/erandomii/ER1_PM2-1.txt
```
- `fit` command ensures that `AMiGA` fits your growth curves with GP regression.
- `-i` or `--input` argument will point to the location of the file of interest<br/>

<br />

Fitting growth curves takes about 1 minutes per 96-well plate. Users can speed this a bit by thinning the input to the GP regression model with the `--time-step-size` parameter. See [Command Line Interface](/amiga/doc/command-line-interface.html) for more details.

<br /> 

#### `fit` summarizes growth curves

Before model-fitting, `AMiGA` will first compute the following metrics for all growth curves:

|Metric|Description|
|:---|:---|
|OD_Baseline|The OD measurement at the first time point|
|OD_Min|The minimum OD measurement at any time points|
|OD_Max|The maximum OD measurement at any time points|
|Fold_Change|defined as the ratio of change in OD of the case (or treatment) growth curve relative to change in OD of the control growth curve|

<br />

#### `fit` manipulates growth curves

`AMiGA` will then apply the following transformations to you data:
1. Conversion of time units (e.g. from seconds to hours). Choice of units is defined in `amiga\libs\config.py`.
2. Natural logarithmic transformation (i.e. OD &#8594; ln(OD))
3. Adjustment of the baseline by normalizing data to the first time point such that growth cuves alway start at approximately ln(OD)=0 or OD=1. This can be done by either (a) subtracting the initial ln(OD) measurement from all subsequent ln(OD) measurements, or (b) using a polynomial regression-based estimate of ln(OD) at the first time point. The former option is used by default. The latter option is only helpful for fitting of pooled experimental or technical replicates where the starting OD varies albeit only slightly. If the starting OD varies by a lot, you will introduce significant artifical biases into the model. To use the latter method, set `config['PolyFit']` to `True` in `amiga\libs\config.py`. See [Adjusting OD](#adjusting-od) for moe details on how to interpret Adjusted OD(t) or ln OD(t).

<br />

#### `fit` models growth using GP regression.


Finally, `AMiGA` will model a growth curve using GP regression, estimate the following growth parameters, and save them in a tab-separated file with the suffix `_summary.txt`.

|Short Name|Long Name|Description|
|:---|:---|
|auc_lin|AUC (lin)|Area Under the curve (in units of OD, and based on user-specified of time)|
|auc_log|AUC (log)|Area Under the curve (in units of log OD, and based on user-specified of time)|
|death_lin|Death (lin)|Total loss of growth (in units of OD)|
|death_log|Death (log)|Total loss of growth in units of log-OD)|
|diauxie|Diauxie|Multi-phasic grwoth (True or False)|
|dr|Death Rate|Maximum specific death rate|
|gr|Growth Rate|Maximum specific growth rate|
|k_lin|Carrying Capacity (lin)|Carrying capacity (in units of OD, assumes that OD starts at 0)|
|k_log|Carrying Capacity (log)|Carrying capacity (in units of log OD, assumes that OD starts at 0)|
|lagC|Lag Time|Time delay needed to enter exponential growth|
|lagP|Adaptation Time|Time delay needed to initiate positive growth|
|t_dr|Time at Max. Death Rate|Time point at which minimum gowth rate (i.e. maximum death rate) is reached|
|t_gr|Time at Max. Growth Rate|Time point at which maximum growth rate is reached|
|t_k|Time at Carrying Capacity|Time point at which carrying capacity is eached|
|td|Doubling time|Doubling Time 

<br />

#### Bonus: `fit` can detect and charaterize diauxic shifts.


If AMiGA detects multi-phasic growth (e.g. diauxic shift) in any well, it will also characterize the above growth parameters for each unique growth phase. These additional parameters will be saved in a separate tab-separated file with the suffix `_diauxie.txt`. See [Detect Diauxie](/amiga/doc/diauxic-shift-detection.html) for more details.

<br />
#### The log-based estimates of AUC, K, and Death are relative!

All growth curves should start with a non-zero OD which indicates the starting size of the microbial population. To estimate exponential growth rates and other metrics, `AMiGA` must tansform the OD data with a natural logarithm in order to infer certain metrics like the maximum specific growth rate. Then, to account for variation in the starting OD, the measurement at the first time point is subtracted. In other words. 


First, we apply natural log transformation

 $$f(t) = \ln{\text{OD}(t)}$$

Second, we subtract first time point

$$f(t) = \ln{\text{OD}(t)}- \ln{\text{OD}(0)}$$

which is equivalent to

$$f(t) = \ln{\frac{\text{OD}(t)}{\text{OD}(0)}} = $$

So at the first time point

$$f(0) = \ln{\frac{\text{OD}(0)}{\text{OD}(0)}} = \ln{1} = 0$$

and all measurements of OD at other time points is thus relative to an arbitrary initial measurement of OD(0). This affects several metrics in particular AUC_log, K_log, and Death_log. 

In other words, whereas the linear estimate of K and AUC is in units of OD and OD x time, respectively,
 
 
$$\text{K_lin} = \max_t \text{OD} (t) $$

$$\text{AUC_lin} = \int \text{OD} (t) dt $$

th log estimate of K and AUC is arbitrary and relative to to what the K or AUC would have been if there was no growth at all (in that case AUC_log would be equal to 1).

$$\text{K_log} = \max_t \left(\frac{\text{OD(t)}}{\text{OD}(0)}\right)$$

$$\text{AUC_log} = \int \ln{\frac{\text{OD}(t)}{\text{OD}(0)}} dt $$


<br />
#### What happens if the starting OD of a curve is zero?
All growth curves should start with a non-zero OD which indicates the starting size of the microbial population. To estimate exponential growth rates and other metrics, `AMiGA` must tansform the OD data with a natural logarithm in order to infer certain metrics like the maximum specific growth rate. Because the logarithm of zero is not defined, `AMiGA` will shift the whole growth curve up the smallest absolute difference between any consecutive measurmenets in the curve, i.e., $$\min\:\:\left|\text{OD}(t+1) - \text{OD}(t)\right|\:\:\forall\:\:t$$. 


<br />
#### Command-Line arguments

To see the full list of arguments that `amiga fit` will accept, run

```bash
python amiga.py fit --help
```
which will return the following message

```bash
usage: amiga.py [-h] -i INPUT [-o OUTPUT] [-f FLAG] [-s SUBSET] [-t INTERVAL]
                [-tss TIME_STEP_SIZE] [-sfn SKIP_FIRST_N]
                [--keep-missing-time-points] [--verbose] [--plot]
                [--plot-derivative] [--pool-by POOL_BY] [--save-cleaned-data]
                [--save-mapping-tables] [--save-gp-data] [--merge-summary]
                [--fix-noise] [--sample-posterior]

Fit growth curves

optional arguments:
  -h, --help            show this help message and exit
  -i INPUT, --input INPUT
  -o OUTPUT, --output OUTPUT
  -f FLAG, --flag FLAG
  -s SUBSET, --subset SUBSET
  -t INTERVAL, --interval INTERVAL
  -tss TIME_STEP_SIZE, --time-step-size TIME_STEP_SIZE
  -sfn SKIP_FIRST_N, --skip-first-n SKIP_FIRST_N
  --keep-missing-time-points
  --verbose
  --plot
  --plot-derivative
  --pool-by POOL_BY
  --save-cleaned-data
  --save-mapping-tables
  --save-gp-data
  --merge-summary
  --fix-noise
  --sample-posterior
```

<br/>
See more details for these arguments in [Command Line Interface](/amiga/doc/command-line-interface.html)
